---
title: 技术场景之解决重复请求
cover:  /img/technology-sense/request_repeated_title.png
subtitle: 技术场景之解决重复请求
categories: "技术场景"
tags: "技术场景"
author:
  nick: 袁苏东
  link: https://github.com/yuansudong
typora-root-url: images
---



何为重复请求? 即期望请求一次的接口,重复请求了多次. 倘若要解决重复请求,就需要实现接口的幂等性.



何为幂等?幂等(idempotent、idempotence)是一个数学与计算机学概念,常见于抽象代数中.在编程中,幂等是指无论执行多少次,其结果与第一次执行的结果相同.



何为接口幂等?接口幂等,即同一个网络请求无论多少次进入服务器,其产生的影响与第一次进入服务器的影响相同.而要实现接口幂等,首先得分析,CRUD的幂等性





### 01.CRUD幂等



CRUD 即Create,Read,Update,Delete的简写.其语义对应着SQL中的Insert,Select,Update,Delete 语句.



#### A.  Create 创建类操作

  

在数据库中,数据的创建是通过主键自增+唯一索引的方式来确定一行数据.其操作不具备幂等性



#### B.  Read 查询类操作



不考虑并发的情况下,在数据查询中,不会修改或者新数增数据,其操作无论执行多少次,其返回的结果与第一次操作的情况相同.



可谓是天然幂等.



#### C.  Update 更新类操作



基于主键的计算式Update,不具备幂等性.比如下列的SQL语句.多次执行的结果,与第一次执行的结果不同



```
UPDATE Bi SET Bi.Number = Bi.Number - 1 WHERE Bi.Id = 1
```



基于主键的非计算式Update,具备幂等性.比如下列的SQL语句.多次执行的结果与第一次执行的结果相同.



```
UPDATE Bi SET Bi.Number = @Value WHERE Bi.Id = 1
```



#### D.  Delete 删除类操作



基于主键的delete是具备幂等性的.比如,下列的SQL语句



```
DELETE FROM Bi WHERE Bi.Id = 1
```



基于逻辑删除,将DeletedAt字段置为当前时间.在查询时过滤掉该条数据.



如此方式,在数据层面不具有幂等性.但是,在逻辑方面他具有了幂等性.比如,下列的SQL语句.



```
UPDATE Bi SET Bi.DeletedAt = {{当前的时间戳}} WHERE Bi.Id = 1
```



### 02.原因分析及其解决方案



#### 01.重复点击

重复点击,即,用户不小心双击或者测试人员恶意双击造成的重复请求

对于这一类的重复请求.通用的解决方案是客户端在一个请求未结束之前,将点击按钮置为灰色,让按钮失去执行接口的能力.

#### 06.在浏览器中因为后退等操作按钮,导致POST重复提交

05.网络波动引起的重复请求

04.RPC调用时,重试引起的重复调用



对于这三类问题,有下列几种解决办法.



第一种方案: 在正式执行接口之前,客户端先通过I1接口申请一个单次准入令牌.该令牌全局唯一,且有效时间为5分钟.客户端在发起正式请求时,在带header中带上单次准入令牌.服务器根据此准入令牌,与redis中进行删除操作,只有删除的个数为1时,才会允许放行. 否则返回相关错误码,客户端根据错误码提示操作太频繁或者网络出小差再试一次等提示.



优点:  客户端不用挂心准入令牌的生成,实现了各端的统一,且服务器可以根据准入令牌做限流处理.



缺点:  增加了TPS的耗时,增加了客户端的编码量(因人而异).  



第二种方案: 客户端自行生成一个唯一标识符.与以前项目中,客户端感觉每次请求之前都要去服务器拿准入token,有些麻烦,所以决定自己生成.

在生成之后,通过将其加入header中带入服务器.服务器根据数据表中的唯一索引,或者SQL执行受影响的行数,可以确保幂等.



下面是以前合作的搭档对于唯一标识符的生成方式.



```
bString = {精确到纳秒的时间戳}_{设备标识符}_md5(请求体)_sha1(请求体)
md5Body = md5(bString)
sha1Body = sha1(bString)
requestId = md5Body_sha1Body  
```



requestId 就是需要带在header中的请求ID